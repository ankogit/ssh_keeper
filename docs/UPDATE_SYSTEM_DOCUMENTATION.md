# Система обновлений SSH Keeper

## Обзор

SSH Keeper теперь включает в себя полноценную систему автоматических обновлений, которая позволяет пользователям легко получать и устанавливать новые версии приложения.

## Компоненты системы

### 1. UpdateService (`internal/services/update_service.go`)

Основной сервис для работы с обновлениями:

- **Проверка обновлений**: Подключение к GitHub API для получения информации о последних релизах
- **Загрузка обновлений**: Автоматическая загрузка подходящих файлов для текущей платформы
- **Установка обновлений**: Извлечение и замена исполняемого файла с созданием резервных копий
- **Перезапуск приложения**: Автоматический перезапуск после установки обновления

### 2. AutoUpdateService (`internal/services/auto_update_service.go`)

Сервис для управления автоматическими проверками:

- **Автоматическая проверка**: Проверка обновлений при запуске приложения
- **Настройка интервалов**: Конфигурируемые интервалы проверки (по умолчанию 24 часа)
- **Кэширование времени**: Сохранение времени последней проверки
- **Условная проверка**: Проверка только при необходимости

### 3. UpdatesScreen (`internal/ui/screens/updates_screen.go`)

Пользовательский интерфейс для управления обновлениями:

- **Проверка обновлений**: Ручная проверка наличия новых версий
- **Установка обновлений**: Загрузка и установка доступных обновлений
- **Информация о версиях**: Отображение текущей и доступной версий
- **Настройки**: Планируемые настройки автоматических обновлений

## Конфигурация

### Переменные окружения

```bash
# Настройки обновлений
AUTO_CHECK_UPDATES=true          # Включить автоматическую проверку
UPDATE_CHECK_INTERVAL=24          # Интервал проверки в часах
LAST_UPDATE_CHECK=""              # Время последней проверки (автоматически)
```

### Структура конфигурации

```go
type Config struct {
    // ... другие поля
    Updates struct {
        AutoCheck     bool   `envconfig:"AUTO_CHECK_UPDATES" default:"true"`
        CheckInterval int    `envconfig:"UPDATE_CHECK_INTERVAL" default:"24"`
        LastCheck     string `envconfig:"LAST_UPDATE_CHECK" default:""`
    } `envconfig:"UPDATES"`
}
```

## Использование

### Автоматические обновления

1. **При запуске**: Приложение автоматически проверяет обновления, если прошло достаточно времени с последней проверки
2. **Уведомления**: Если доступно обновление, пользователь получает уведомление в консоли
3. **Настройки**: Пользователь может отключить автоматические проверки через настройки

### Ручное управление

1. **Через меню**: Настройки → Обновления
2. **Проверка**: Нажмите "1" для проверки обновлений
3. **Установка**: Нажмите "2" для загрузки и установки (если доступно)

## Безопасность

### Проверка файлов

- **Платформенная совместимость**: Загружаются только файлы для текущей платформы
- **Резервные копии**: Создается резервная копия перед заменой файла
- **Откат**: При ошибке установки происходит автоматический откат

### Процесс установки

1. Загрузка архива с GitHub
2. Извлечение исполняемого файла
3. Создание резервной копии текущего файла
4. Замена файла новым
5. Установка прав на выполнение
6. Очистка временных файлов

## Поддерживаемые форматы

- **Linux/macOS**: `.tar.gz` архивы
- **Windows**: `.zip` архивы

## GitHub API

Система использует GitHub API для получения информации о релизах:

- **Endpoint**: `https://api.github.com/repos/ankogit/ssh_keeper/releases/latest`
- **Аутентификация**: Не требуется (публичные релизы)
- **Rate limiting**: Стандартные ограничения GitHub API

## Структура релизов

Ожидаемая структура релизов на GitHub:

```
ssh-keeper-v1.0.0-darwin-amd64.tar.gz
ssh-keeper-v1.0.0-darwin-arm64.tar.gz
ssh-keeper-v1.0.0-linux-amd64.tar.gz
ssh-keeper-v1.0.0-windows-amd64.zip
```

## Обработка ошибок

### Типичные ошибки

1. **Сетевые проблемы**: Таймауты, отсутствие интернета
2. **Права доступа**: Недостаточные права для записи файлов
3. **Платформенные проблемы**: Неподдерживаемые архитектуры
4. **Поврежденные архивы**: Ошибки при извлечении файлов

### Восстановление

- **Автоматический откат**: При ошибке установки файл восстанавливается из резервной копии
- **Логирование**: Все ошибки логируются для диагностики
- **Graceful degradation**: При ошибках система продолжает работать

## Будущие улучшения

1. **Настройки обновлений**: Экран для конфигурации автоматических обновлений
2. **Уведомления в UI**: Интеграция уведомлений об обновлениях в интерфейс
3. **Проверка подписей**: Валидация цифровых подписей релизов
4. **Дельта-обновления**: Загрузка только изменений
5. **Rollback**: Возможность отката к предыдущей версии

## Тестирование

### Ручное тестирование

1. Создайте тестовый релиз на GitHub
2. Установите старую версию приложения
3. Проверьте автоматическое обнаружение обновления
4. Протестируйте процесс установки

### Автоматическое тестирование

```bash
# Проверка компиляции
go build ./cmd/ssh-keeper

# Проверка линтера
golangci-lint run

# Запуск тестов
go test ./...
```

## Мониторинг

### Логи

Система обновлений логирует следующие события:

- Проверка обновлений
- Найденные обновления
- Процесс загрузки
- Установка обновлений
- Ошибки

### Метрики

- Время последней проверки
- Количество доступных обновлений
- Статус установки
- Частота ошибок

## Заключение

Система обновлений SSH Keeper обеспечивает:

- ✅ Автоматическое обнаружение новых версий
- ✅ Безопасную установку обновлений
- ✅ Простой пользовательский интерфейс
- ✅ Надежную обработку ошибок
- ✅ Кроссплатформенную совместимость

Пользователи теперь могут легко поддерживать свое приложение в актуальном состоянии, получая новые функции и исправления безопасности автоматически.
